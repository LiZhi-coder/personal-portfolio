FROM node:22-alpine AS build

WORKDIR /app

COPY package.json pnpm-lock.yaml ./
COPY patches ./patches
COPY client ./client
COPY server ./server
COPY scripts ./scripts
COPY shared ./shared
COPY vite.config.ts tsconfig.json tsconfig.node.json ./

RUN corepack enable && pnpm install --frozen-lockfile
RUN pnpm build

FROM nginx:1.27-alpine

COPY infra/nginx/portfolio.conf /etc/nginx/conf.d/default.conf
COPY --from=build /app/dist/public /usr/share/nginx/html

EXPOSE 80
